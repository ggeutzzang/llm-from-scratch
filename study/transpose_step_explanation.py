"""
STEP 3ì˜ ì „ì¹˜ê°€ ì™œ í•„ìš”í•œê°€?
================================

ë©€í‹°í—¤ë“œ ì–´í…ì…˜ì—ì„œ ì „ì¹˜ëŠ” "í—¤ë“œë³„ ë³‘ë ¬ ì²˜ë¦¬"ë¥¼ ìœ„í•œ ê²ƒì…ë‹ˆë‹¤!
"""

import torch
import torch.nn as nn

print("=" * 80)
print("STEP 3 ì „ì¹˜ì˜ ì˜ë¯¸ë¥¼ ì´í•´í•´ë³´ì!")
print("=" * 80)

# ê°„ë‹¨í•œ ë°ì´í„° ì¤€ë¹„
batch_size = 1
num_tokens = 3
num_heads = 2
head_dim = 1

# ì˜ˆì œ: queriesì˜ ëª¨ì–‘
# (1, 3, 2) â†’ STEP 2ì—ì„œ reshape â†’ (1, 3, 2, 1)
queries_multi = torch.tensor([
    [
        [[0.1], [0.3]],    # í† í° 0: [í—¤ë“œ0_ê°’, í—¤ë“œ1_ê°’]
        [[0.15], [0.35]],  # í† í° 1: [í—¤ë“œ0_ê°’, í—¤ë“œ1_ê°’]
        [[0.2], [0.4]]     # í† í° 2: [í—¤ë“œ0_ê°’, í—¤ë“œ1_ê°’]
    ]
], dtype=torch.float32)

print(f"\nğŸ“¦ STEP 2 í›„ queries_multiì˜ shape: {queries_multi.shape}")
print(f"   (batch_size=1, num_tokens=3, num_heads=2, head_dim=1)")
print(f"\nqueries_multi ë‚´ìš©:")
print(queries_multi)

print("\n" + "=" * 80)
print("âŒ ë§Œì•½ ì „ì¹˜í•˜ì§€ ì•Šê³  ë°”ë¡œ í–‰ë ¬ ê³±ì…ˆì„ í•œë‹¤ë©´?")
print("=" * 80)

# ì „ì¹˜ ì—†ì´ ì§ì ‘ ê³±í•˜ê¸° ì‹œë„
print(f"\ní˜„ì¬ shape: {queries_multi.shape}")
print(f"í–‰ë ¬ ê³±ì…ˆì„ í•˜ë ¤ë©´: (1, 3, 2, 1) @ (1, 3, 1, 2) í•„ìš”")
print(f"í•˜ì§€ë§Œ í˜„ì¬ êµ¬ì¡°ë¡œëŠ” ì´ê²Œ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤! ì™œ?")
print(f"""
  ì™œëƒí•˜ë©´:
  - í† í°(dim=1)ê³¼ í—¤ë“œ(dim=2)ê°€ ë¶„ë¦¬ë˜ì–´ ìˆìŒ
  - ê° í—¤ë“œë³„ë¡œ ë…ë¦½ì ì¸ ì–´í…ì…˜ ê³„ì‚°ì„ í•˜ê¸° ì–´ë ¤ì›€
  - ë°°ì¹˜ í–‰ë ¬ ê³±ì…ˆì€ **ë§ˆì§€ë§‰ ë‘ ì°¨ì›**ë§Œ í–‰ë ¬ ê³±í•˜ê¸° ìˆ˜í–‰
    (ì²« ì°¨ì›ë“¤ì€ "ë°°ì¹˜" ì²˜ë¦¬ë¡œ ì·¨ê¸‰)
""")

print("=" * 80)
print("âœ… ì „ì¹˜í•˜ëŠ” ì´ìœ : í—¤ë“œë¥¼ ë°°ì¹˜ ì°¨ì›ìœ¼ë¡œ ìŠ¹ê²©!")
print("=" * 80)

# STEP 3: ì „ì¹˜
queries_T = queries_multi.transpose(1, 2)  # (1, 3, 2, 1) â†’ (1, 2, 3, 1)

print(f"\nì „ì¹˜ í›„ queries_T shape: {queries_T.shape}")
print(f"(batch_size=1, num_heads=2, num_tokens=3, head_dim=1)")
print(f"\nqueries_T ë‚´ìš©:")
print(queries_T)

print(f"""
[í•µì‹¬ ì•„ì´ë””ì–´]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ì „ì¹˜ ì „: (1, 3, 2, 1)
         batch, tokens, heads, head_dim

ì „ì¹˜ í›„: (1, 2, 3, 1)
         batch, heads, tokens, head_dim

ì´ì œ PyTorchëŠ” ì´ë ‡ê²Œ í•´ì„í•©ë‹ˆë‹¤:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "2ê°œ í—¤ë“œ"ë¥¼ ë°°ì¹˜ë¡œ ì²˜ë¦¬í•´ì•¼ í•œë‹¤!  â”‚
â”‚                                     â”‚
â”‚ ì¦‰, 2ê°œì˜ (1, 3, 1) ë°°ì¹˜            â”‚
â”‚    ê°ê°ì— ëŒ€í•´ ë…ë¦½ì ìœ¼ë¡œ ì–´í…ì…˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
""")

print("=" * 80)
print("ğŸ” êµ¬ì²´ì  ì˜ˆ: í—¤ë“œë³„ë¡œ ë¶„ë¦¬ë˜ëŠ” ëª¨ìŠµ")
print("=" * 80)

print(f"\ní—¤ë“œ 0ë§Œ ì¶”ì¶œ:")
print(f"  queries_T[0, 0, :, :] shape: {queries_T[0, 0, :, :].shape}")
print(f"  ë°ì´í„°: {queries_T[0, 0, :, :]}")
print(f"  ì˜ë¯¸: í† í° 3ê°œì˜ í—¤ë“œ0 ì¿¼ë¦¬ê°’ [0.1, 0.15, 0.2]")

print(f"\ní—¤ë“œ 1ë§Œ ì¶”ì¶œ:")
print(f"  queries_T[0, 1, :, :] shape: {queries_T[0, 1, :, :].shape}")
print(f"  ë°ì´í„°: {queries_T[0, 1, :, :]}")
print(f"  ì˜ë¯¸: í† í° 3ê°œì˜ í—¤ë“œ1 ì¿¼ë¦¬ê°’ [0.3, 0.35, 0.4]")

print("\n" + "=" * 80)
print("ğŸ“ STEP 4ì—ì„œ í–‰ë ¬ ê³±ì…ˆì´ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ê°€?")
print("=" * 80)

keys_T = queries_T.clone()  # ê°„ë‹¨íˆ ê°™ë‹¤ê³  ê°€ì •

print(f"\nqueries_T shape: {queries_T.shape}")
print(f"keys_T shape: {keys_T.shape}")

# keys_Të¥¼ ë˜ ì „ì¹˜
keys_T_transposed = keys_T.transpose(2, 3)
print(f"keys_T.transpose(2, 3) shape: {keys_T_transposed.shape}")
print(f"  (batch, num_heads, head_dim, num_tokens)")

print(f"""
ğŸ”¢ í–‰ë ¬ ê³±ì…ˆ ì‘ë™:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

queries_T @ keys_T.transpose(2, 3)
= (1, 2, 3, 1) @ (1, 2, 1, 3)

PyTorchì˜ ë°°ì¹˜ @ ì—°ì‚° ê·œì¹™:
- ì²« ë²ˆì§¸ ë°°ì¹˜ ì°¨ì›ë“¤ ìœ ì§€: (1, 2)
- ë§ˆì§€ë§‰ ë‘ ì°¨ì›ë§Œ í–‰ë ¬ ê³±í•˜ê¸°: (3, 1) @ (1, 3) = (3, 3)

ê²°ê³¼: (1, 2, 3, 3)
      ë°°ì¹˜, í—¤ë“œ, ì¿¼ë¦¬í† í°, í‚¤í† í°

ì¦‰, 2ê°œ í—¤ë“œ ê°ê°ì— ëŒ€í•´:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ í—¤ë“œ 0: (3, 1) @ (1, 3) = (3, 3)    â”‚
â”‚ í—¤ë“œ 1: (3, 1) @ (1, 3) = (3, 3)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì´ë ‡ê²Œ **ë³‘ë ¬ë¡œ** 2ê°œ í—¤ë“œë¥¼ ë™ì‹œì— ì²˜ë¦¬!
""")

print("=" * 80)
print("âŒ ì „ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ì–´ë–»ê²Œ ë ê¹Œ?")
print("=" * 80)

print(f"""
ì „ì¹˜ ì—†ì´ (1, 3, 2, 1)ë¡œ ë°”ë¡œ ê³±í•˜ë ¤ë©´:

  (1, 3, 2, 1) @ (1, 3, 1, 2)

PyTorchëŠ” ì´ë ‡ê²Œ í•´ì„:
  - ë°°ì¹˜ ì°¨ì›: (1, 3)
  - í–‰ë ¬ ê³±í•˜ê¸°: (2, 1) @ (1, 2) = (2, 2)

ê²°ê³¼: (1, 3, 2, 2) âŒ ì´ê±´ ìš°ë¦¬ê°€ ì›í•˜ëŠ” êµ¬ì¡°ê°€ ì•„ë‹˜!

ì›í•˜ëŠ” ê²ƒ: ê° í—¤ë“œë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ì–´í…ì…˜ ê³„ì‚°
ì–»ì–´ì§€ëŠ” ê²ƒ: í† í°ë³„ë¡œ í˜¼ì¡í•œ êµ¬ì¡°
""")

print("\n" + "=" * 80)
print("ğŸ’¡ ìµœì¢… ì •ë¦¬")
print("=" * 80)

print("""
1ï¸âƒ£ STEP 2 (reshape):
   (batch, tokens, d_out)
   â†’ (batch, tokens, num_heads, head_dim)

   'ì¶œë ¥ ì°¨ì›'ì„ 'í—¤ë“œ'ë¡œ ë¶„í•´

2ï¸âƒ£ STEP 3 (transpose):
   (batch, tokens, num_heads, head_dim)
   â†’ (batch, num_heads, tokens, head_dim)

   í—¤ë“œë¥¼ ë°°ì¹˜ ì°¨ì›ìœ¼ë¡œ ìŠ¹ê²©!
   â†’ ì´ì œ "num_headsê°œì˜ ë°°ì¹˜"ë¡œ ì²˜ë¦¬ ê°€ëŠ¥
   â†’ PyTorchì˜ ë°°ì¹˜ í–‰ë ¬ ê³±ì…ˆ í™œìš© ê°€ëŠ¥

3ï¸âƒ£ STEP 4 (matmul):
   (batch, num_heads, tokens, head_dim) @ (batch, num_heads, head_dim, tokens)
   = (batch, num_heads, tokens, tokens)

   ê° í—¤ë“œë³„ë¡œ ë…ë¦½ì ì¸ ì–´í…ì…˜ ì ìˆ˜ ê³„ì‚°!
   â†’ ë³‘ë ¬ ì²˜ë¦¬ë¡œ íš¨ìœ¨ì !

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ê²°ë¡ : ì „ì¹˜ëŠ” "í—¤ë“œë³„ ë³‘ë ¬ ì²˜ë¦¬"ë¥¼ ìœ„í•œ í•„ìˆ˜ êµ¬ì¡° ë³€í™˜!
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
""")

print("\n" + "=" * 80)
print("ğŸ¯ ì‹¤ì œ ê³„ì‚° ì˜ˆì œ")
print("=" * 80)

# ê°„ë‹¨í•œ ìˆ«ìë¡œ ì§ì ‘ ê³„ì‚°
print("\n[ì†ìœ¼ë¡œ ê³„ì‚°í•˜ëŠ” ì˜ˆ]")
print(f"í—¤ë“œ 0ë§Œ ë´¤ì„ ë•Œ:")
print(f"  queries_T[0, 0, :, :] = {queries_T[0, 0, :, :].squeeze()}")
print(f"  keys_T[0, 0, :, :] = {keys_T[0, 0, :, :].squeeze()}")
print(f"  queries_T[0, 0, :, :] @ keys_T[0, 0, :, :].T =")

result_head0 = queries_T[0, 0, :, :] @ keys_T[0, 0, :, :].transpose(0, 1)
print(f"  {result_head0}")

print(f"\ní—¤ë“œ 1ë§Œ ë´¤ì„ ë•Œ:")
print(f"  queries_T[0, 1, :, :] @ keys_T[0, 1, :, :].T =")
result_head1 = queries_T[0, 1, :, :] @ keys_T[0, 1, :, :].transpose(0, 1)
print(f"  {result_head1}")

print(f"\në°°ì¹˜ ì—°ì‚°ìœ¼ë¡œ í•œ ë²ˆì—:")
result_batch = queries_T @ keys_T.transpose(2, 3)
print(f"  queries_T @ keys_T.transpose(2, 3) =")
print(f"  {result_batch}")
print(f"\nâœ… ë™ì¼í•œ ê²°ê³¼!")
